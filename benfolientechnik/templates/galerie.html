{% extends "base.html" %}
{% load static %}
{% block extracss %}
  <link rel="stylesheet" href="{% static 'css/galerie.css' %}?{% now 'U' %}">
{% endblock %}
{% block title %}
<title>Galerie</title>
{% endblock %}
{% block content %}

    <div class="container">
        <div class="header">
            <div class="logotext">BEN FOLIENTECHNIK</div>
            <div class="subtitle">Bilder-Galerie abgeschlossener Projekte</div>
        </div>

        <div class="gallery-categories">
            <button class="category-btn active" data-category="all">Alle Projekte</button>
            <button class="category-btn" data-category="folierung">Fahrzeugfolierung</button>
            <button class="category-btn" data-category="beschriftung">Werbebeschriftung</button>
        </div>

        <div class="gallery-grid">
            {% for gallery_item in gallery_images %}
            <div class="project-card" data-category="{{ gallery_item.category }}">
                <div class="project-image-container">
                    {% if gallery_item.images.exists %}
                        <div class="image-carousel" data-gallery-id="{{ gallery_item.id }}">
                            {% for image in gallery_item.images.all %}
                            <img src="{{ image.image.url }}" alt="{{ gallery_item.title }} - Bild {{ forloop.counter }}" class="carousel-image {% if forloop.first %}active{% endif %}"/>
                            {% endfor %}
                        </div>

                        {% if gallery_item.image_count > 1 %}
                        <div class="carousel-indicators">
                            {% for image in gallery_item.images.all %}
                            <span class="indicator {% if forloop.first %}active{% endif %}" data-slide="{{ forloop.counter0 }}"></span>
                            {% endfor %}
                        </div>

                        <div class="carousel-navigation">
                            <button class="carousel-btn prev" onclick="changeSlide({{ gallery_item.id }}, -1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="carousel-btn next" onclick="changeSlide({{ gallery_item.id }}, 1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="no-image">Kein Bild verfügbar</div>
                    {% endif %}
                </div>

                <div class="project-info">
                    <div class="project-title">{{ gallery_item.title }}</div>
                    <div class="project-description">
                        {{ gallery_item.description|default:"Professionelle Fahrzeugfolierung und Beschriftung." }}
                    </div>
                    <div class="project-meta">
                        <span class="image-count">{{ gallery_item.image_count }} {% if gallery_item.image_count == 1 %}Bild{% else %}Bilder{% endif %}</span>
                        <span class="category-badge">{{ gallery_item.get_category_display }}</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="no-images">
                <p>Noch keine Galerie-Bilder vorhanden. Bilder können im Admin-Bereich hinzugefügt werden.</p>
            </div>
            {% endfor %}

        <div class="cta-section">
            <div class="cta-title">Ihr Projekt ist nicht dabei?</div>
            <div class="cta-text">
                Lassen Sie uns gemeinsam Ihr individuelles Projekt realisieren!<br>
                Rufen Sie mich an für eine kostenlose Beratung.
            </div>
            <a href="{% url 'kontakt' %}" class="contact-btn">
        <span><i class="fa-solid fa-phone"></i></span>
        Jetzt anfragen
      </a>
        </div>
    </div>

    <!-- Modal für Bildvergrößerung -->
    <div class="moda" id="imageModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times; Schließen</button>
            <img class="modal-image" id="modalImage" src="" alt="Vergrößerte Ansicht">
        </div>
    </div>

    <script>
        // Kategorie-Filter
        const categoryButtons = document.querySelectorAll('.category-btn');
        const projectCards = document.querySelectorAll('.project-card');

        categoryButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // Aktiven Button wechseln
                categoryButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const category = btn.dataset.category;

                // Projekte filtern
                projectCards.forEach(card => {
                    if (category === 'all' || card.dataset.category === category) {
                        card.style.display = 'block';
                        setTimeout(() => card.style.opacity = '1', 10);
                    } else {
                        card.style.opacity = '0';
                        setTimeout(() => card.style.display = 'none', 300);
                    }
                });
            });
        });

        // Carousel-Funktionalität
        function changeSlide(galleryId, direction) {
            const carousel = document.querySelector(`.image-carousel[data-gallery-id="${galleryId}"]`);
            if (!carousel) return;

            const images = carousel.querySelectorAll('.carousel-image');
            const indicators = carousel.parentElement.querySelectorAll('.indicator');

            let currentIndex = Array.from(images).findIndex(img => img.classList.contains('active'));

            // Aktuelles Bild deaktivieren
            images[currentIndex].classList.remove('active');
            if (indicators.length > 0) {
                indicators[currentIndex].classList.remove('active');
            }

            // Neuen Index berechnen
            currentIndex = (currentIndex + direction + images.length) % images.length;

            // Neues Bild aktivieren
            images[currentIndex].classList.add('active');
            if (indicators.length > 0) {
                indicators[currentIndex].classList.add('active');
            }
        }

        // Indicator-Klicks
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('indicator')) {
                const galleryId = e.target.closest('.project-image-container').querySelector('.image-carousel').dataset.galleryId;
                const slideIndex = parseInt(e.target.dataset.slide);
                const carousel = document.querySelector(`.image-carousel[data-gallery-id="${galleryId}"]`);
                const images = carousel.querySelectorAll('.carousel-image');
                const indicators = carousel.parentElement.querySelectorAll('.indicator');

                // Alle Bilder/Indicators deaktivieren
                images.forEach(img => img.classList.remove('active'));
                indicators.forEach(ind => ind.classList.remove('active'));

                // Gewähltes Bild/Indicator aktivieren
                images[slideIndex].classList.add('active');
                indicators[slideIndex].classList.add('active');
            }
        });

        // Modal für Bildvergrößerung
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');

        function openModal(imageSrc, title) {
            modalImage.src = imageSrc;
            modalImage.alt = title;
            modal.classList.add('active');
        }

        function closeModal() {
            modal.classList.remove('active');
        }

        // Modal schließen bei Klick außerhalb
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // ESC Taste zum Schließen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Bilder im Carousel klickbar machen für Modal
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('carousel-image')) {
                const galleryCard = e.target.closest('.project-card');
                const title = galleryCard.querySelector('.project-title').textContent;
                openModal(e.target.src, title);
            }
        });

        // Touch/Swipe-Funktionalität für mobile Geräte
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let isHorizontalSwipe = false;
        const minSwipeDistance = 50; // Minimale Distanz für einen gültigen Swipe

        // Touch-Events zu allen Carousel-Containern hinzufügen
        document.querySelectorAll('.project-image-container').forEach(container => {
            const carousel = container.querySelector('.image-carousel');
            if (!carousel) return;

            container.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
                isHorizontalSwipe = false;
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (touchStartX === 0 || touchStartY === 0) return;

                const currentX = e.changedTouches[0].screenX;
                const currentY = e.changedTouches[0].screenY;
                const deltaX = Math.abs(currentX - touchStartX);
                const deltaY = Math.abs(currentY - touchStartY);

                // Nur horizontale Swipes blockieren (wenn horizontale Bewegung stärker ist)
                if (deltaX > deltaY && deltaX > 10) {
                    isHorizontalSwipe = true;
                    e.preventDefault(); // Verhindere Scrolling nur bei horizontalen Swipes
                }
            }, { passive: false });

            container.addEventListener('touchend', (e) => {
                if (!isHorizontalSwipe) return;

                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;

                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;

                // Prüfe ob es ein horizontaler Swipe war (größer als vertikale Bewegung)
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                    const galleryId = carousel.dataset.galleryId;
                    const direction = deltaX > 0 ? -1 : 1; // Links swipe = vorheriges Bild, Rechts swipe = nächstes Bild
                    changeSlide(galleryId, direction);
                }

                // Reset touch coordinates
                touchStartX = 0;
                touchStartY = 0;
                touchEndX = 0;
                touchEndY = 0;
                isHorizontalSwipe = false;
            }, { passive: true });
        });

        // Smooth Transitions für Karten
        projectCards.forEach(card => {
            card.style.opacity = '1';
            card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        });
    </script>

{% endblock %}